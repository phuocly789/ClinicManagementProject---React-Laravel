version: '3.8'

services:
  # ========================================
  # BACKEND: Laravel API Server
  # ========================================
  backend:
    build:
      context: ./clinic-management-backend
      dockerfile: ../Dockerfile.backend
    container_name: laravel-app
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ./clinic-management-backend:/var/www/html
    env_file:
      - ./clinic-management-backend/.env
    environment:
      - DB_CONNECTION=pgsql
      - DB_HOST=aws-1-ap-south-1.pooler.supabase.com
      - DB_PORT=5432
      - DB_DATABASE=postgres
      - DB_USERNAME=postgres.phzrctyceyysendeluac
      - DB_PASSWORD=lmp@123
      - DB_SSLMODE=require
      - APP_ENV=local
      - APP_DEBUG=true
      - XDEBUG_MODE=develop,debug
      - XDEBUG_CONFIG=client_host=host.docker.internal
    ports:
      - "8000:8000"  # Laravel API
      - "9003:9003"  # Xdebug
    networks:
      - app-network
    command: bash -c "if [ ! -d vendor ]; then composer install --no-dev --optimize-autoloader; fi && php artisan serve --host=0.0.0.0 --port=8000"

  # ========================================
  # REVERB: WebSocket Server (REALTIME)
  # ========================================
  reverb:
    build:
      context: ./clinic-management-backend
      dockerfile: ../Dockerfile.backend
    container_name: laravel-reverb
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ./clinic-management-backend:/var/www/html
    env_file:
      - ./clinic-management-backend/.env
    environment:
      - REVERB_SERVER_HOST=0.0.0.0
      - REVERB_SERVER_PORT=8080
      - REVERB_HOST=reverb  # ← Service name
      - REVERB_PORT=8080
      - REVERB_SCHEME=http
    ports:
      - "8080:8080"  # Reverb WebSocket
    networks:
      - app-network
    depends_on:
      - backend
    command: bash -c "sleep 10 && php artisan reverb:start --host=0.0.0.0 --port=8080 --debug"

  # ========================================
  # SCHEDULER: Laravel Cron Jobs
  # ========================================
  scheduler:
    build:
      context: ./clinic-management-backend
      dockerfile: ../Dockerfile.backend
    container_name: laravel-scheduler
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ./clinic-management-backend:/var/www/html
    env_file:
      - ./clinic-management-backend/.env
    networks:
      - app-network
    depends_on:
      - backend
    command: bash -c "sleep 5 && php artisan schedule:work"

  # ========================================
  # QUEUE WORKER: Xử lý Background Jobs
  # ========================================
  queue-worker:
    build:
      context: ./clinic-management-backend
      dockerfile: ../Dockerfile.backend
    container_name: laravel-queue
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ./clinic-management-backend:/var/www/html
    env_file:
      - ./clinic-management-backend/.env
    environment:
      - REVERB_HOST=reverb 
      - REVERB_PORT=8080
      - REVERB_SCHEME=http
    networks:
      - app-network
    depends_on:
      - backend
    command: bash -c "sleep 5 && php artisan queue:work --sleep=3 --tries=3 --verbose"

  # ========================================
  # FRONTEND: React App (Vite)
  # ========================================
  frontend:
    build:
      context: ./clinic-management-frontend
      dockerfile: ../Dockerfile.frontend
    container_name: react-app
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./clinic-management-frontend:/app
      - /app/node_modules
    ports:
      - "3000:5173"
    environment:
      - CHOKIDAR_USEPOLLING=true
    command: npm run dev -- --host 0.0.0.0 --port 5173
    networks:
      - app-network
    stdin_open: true
    tty: true

  # ========================================
  # MAILHOG: Email Testing Tool
  # ========================================
  mailhog:
    image: mailhog/mailhog
    container_name: mailhog
    ports:
      - "8025:8025"  # Web UI
      - "1025:1025"  # SMTP
    networks:
      - app-network

networks:
  app-network:
    driver: bridge