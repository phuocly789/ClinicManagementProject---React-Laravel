version: '3.8'

services:
  # ========================================
  # BACKEND: Laravel API Server
  # ========================================
  backend:
    build:
      context: ./clinic-management-backend
      dockerfile: ../Dockerfile.backend
    container_name: laravel-app
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ./clinic-management-backend:/var/www/html
    env_file:
      - ./clinic-management-backend/.env
    environment:
      # Database Configuration
      - DB_CONNECTION=pgsql
      - DB_HOST=103.75.183.156
      - DB_PORT=5432
      - DB_DATABASE=clinicdb
      - DB_USERNAME=phuoc
      - DB_PASSWORD=Phuoccao@123
      - DB_SSLMODE=disable 
      
      # App Configuration
      - APP_ENV=local
      - APP_DEBUG=true

      # Reverb Configuration
      - BROADCAST_DRIVER=reverb
      - REVERB_APP_ID=clinic_app
      - REVERB_APP_KEY=local_key
      - REVERB_APP_SECRET=local_secret
      - REVERB_HOST=0.0.0.0
      - REVERB_PORT=8080

      # Solr Configuration
      - SOLR_HOST=solr
      - SOLR_PORT=8983
      - SOLR_PATH=/
      - SOLR_CORE=clinic_management
      - SOLR_SCHEME=http
      - SOLR_TIMEOUT=30
      - XDEBUG_MODE=develop,debug
      - XDEBUG_CONFIG=client_host=host.docker.internal
    ports:
      - "8000:8000"  # Laravel API
      - "9003:9003"  # Xdebug
    networks:
      - app-network
    depends_on:
      solr:
        condition: service_healthy
    command: bash -c "if [ ! -d vendor ]; then composer install --no-dev --optimize-autoloader; fi && php artisan serve --host=0.0.0.0 --port=8000"

  # ========================================
  # REVERB: WebSocket Server (REALTIME)
  # ========================================
  reverb:
    build:
      context: ./clinic-management-backend
      dockerfile: ../Dockerfile.backend
    container_name: laravel-reverb
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ./clinic-management-backend:/var/www/html
    env_file:
      - ./clinic-management-backend/.env
    environment:
      - REVERB_SERVER_PORT=8080
      - REVERB_HOST=0.0.0.0
    ports:
      - "8080:8080"  # Reverb WebSocket
    networks:
      - app-network
    depends_on:
      - backend
    command: php artisan reverb:start --host=0.0.0.0 --port=8080

  # ========================================
  # SCHEDULER: Laravel Cron Jobs
  # ========================================
  scheduler:
    build:
      context: ./clinic-management-backend
      dockerfile: ../Dockerfile.backend
    container_name: laravel-scheduler
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ./clinic-management-backend:/var/www/html
    env_file:
      - ./clinic-management-backend/.env
    networks:
      - app-network
    depends_on:
      - backend
    command: php artisan schedule:work

  # ========================================
  # QUEUE WORKER: Xử lý Background Jobs
  # ========================================
  queue-worker:
    build:
      context: ./clinic-management-backend
      dockerfile: ../Dockerfile.backend
    container_name: laravel-queue
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - ./clinic-management-backend:/var/www/html
    env_file:
      - ./clinic-management-backend/.env
    networks:
      - app-network
    depends_on:
      - backend
    command: php artisan queue:work --sleep=3 --tries=3

  # ========================================
  # FRONTEND: React App (Vite)
  # ========================================
  frontend:
    build:
      context: ./clinic-management-frontend
      dockerfile: ../Dockerfile.frontend
    container_name: react-app
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./clinic-management-frontend:/app
      - /app/node_modules
    ports:
      - "3000:5173"
    environment:
      - CHOKIDAR_USEPOLLING=true
      - VITE_REVERB_HOST=localhost
      - VITE_REVERB_PORT=8080
      - VITE_REVERB_SCHEME=http
    command: npm run dev -- --host 0.0.0.0 --port 5173
    networks:
      - app-network
    stdin_open: true
    tty: true

  # ========================================
  # SOLR: Search Engine
  # ========================================
  solr:
    image: solr:8.11
    container_name: solr
    restart: unless-stopped
    ports:
      - "8983:8983"
    volumes:
      - solr_data:/var/solr
    environment:
      - SOLR_HEAP=512m
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8983/solr/admin/cores?action=STATUS"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    command:
      - solr-precreate
      - clinic_management

  # ========================================
  # MAILHOG: Email Testing Tool
  # ========================================
  mailhog:
    image: mailhog/mailhog
    container_name: mailhog
    ports:
      - "8025:8025"  # Web UI
      - "1025:1025"  # SMTP
    networks:
      - app-network
# ========================================
# VOLUMES
# ========================================
volumes:
  solr_data:
  
networks:
  app-network:
    driver: bridge